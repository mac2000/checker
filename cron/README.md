Cron
====

Тул для проверки ключевиков.

Установка
---------

Необходимо выполнить SQL код из файла `install.sql`. Из консоли `mysql -u <user> --password=<pass> <db> < install.sql`
Заполнить файл `config.ini`.
И создать папку с правами на запись `log`.

Аргументы коммандной строки
---------------------------

`-k <keyword>` или `--keyword <keyword>` - **required**. Ключевик для поиска.
`-l <language>` или `--language <language>` - Язык поиска. По умолчанию `lang_en`.
`-c <country>` или `--country <country>` - Страна поиска. По умолчанию `countryUS`.
`-p <proxy>` или `--proxy <proxy>` - значение должно иметь формат `http://<user>:<pass>@<host>:<port>`.

`--nodb` - Не сохранять результат в базу но вывести на экран. Может быть использовано для дебага.

Пример запуска скрипта:

    php -d max_execution_time=0 cron.php -k "Hello World" -p http://user:pass@example.com --nodb

Как это работает
----------------

Первым делом проверяются аргументы, и если среди них нет ключевика - скрипт умирает.

Если среди аргументов была прокся, но в не верном формате либо не рабочая - скрипт умирает отправляя уведомление на почту.

Далее скрипт пытается открыть http://google.com для полчение печенек и если у него это не выходит - он так же умирает отправляя уведомление.

Далее сприпт шаг за шагом тянет десять страниц результатов поиска.

После чего начинает парсить результаты, если все десять страниц вернулись с статусом 503 - мы полчили капчу - отваливаемся и отправляем уведомление.

Если количество ссылок которые удалось выдрать - меньше сотни - возможен вариант что поменялась разметка страницы и нам нужно менять наш xpath - шлем уведомление.

Если не было аргумента `--nodb` сохраняем все что удалось выдрать в базу данных, иначе - просто выводим на экран.

Так же результаты всех запросов сохраняются в папке `log`.

Настройка крона
---------------

В среднем сприкт отпрабатывает за 50-70 секунд, ни туда ни сюда, потому будем запускать каждых две минуты, чтобы не получить бан за лишние запросы.

Пример того на что должен будет быть похож крон:

0 0 * * * php -d max_execution_time=0 cron.php -k "Keyword 1" -p http://user:pass@proxy1.com
2 0 * * * php -d max_execution_time=0 cron.php -k "Keyword 2" -p http://user:pass@proxy1.com
...
58 0 * * * php -d max_execution_time=0 cron.php -k "Keyword 58" -p http://user:pass@proxy1.com
0 1 * * * php -d max_execution_time=0 cron.php -k "Keyword 59" -p http://user:pass@proxy1.com
2 1 * * * php -d max_execution_time=0 cron.php -k "Keyword 60" -p http://user:pass@proxy1.com
...
58 22 * * * php -d max_execution_time=0 cron.php -k "Keyword 720" -p http://user:pass@proxy3.com

Первая цифра - минуты от 0 до 59
Вторая - часы от 0 до 23
Остальные три параметра оставляем * что равносильно тому что мы говорим чтобы каждый такой скрипт запускался каждый день в конкретное время, а именнов в 00:00, 00:02, 00:04, ..., 23:58.

После каждого изменения файла, да и в первый раз тоже, запускаем:

    crontab -u <username> <crontab file>

Что заставит крон перечитать задачи текущего пользователя.

Чтобы посмотреть список задач выполняем `crontab -l`

В случае если по каким либо причинам крон отрабатывается второй раз и записи уже есть они будут обновлены.

Минусы
------

Запускаясь крон ничего не знает о том завершилась ли предыдущая задача.
Мы не можем крутить в кроне скрипт вечно, для этого нужны демоны.
Кроне не умеет перезапускать не удавшиеся задачи.

Набросал простенький скрипт `helper.html` чтобы было понятно на что будет похож cron.

Еще раз, мы не можем сделать в кроне одну запись которая должна будет постоянно крутится и все делать - крон так не умеет, именно потому я и хотел сделать через сервер очередей.
